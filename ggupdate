#!/usr/bin/env bash
. $(which _gg_check_root)
. $(which _gg_check_layer)

pwd_before_update=$(pwd)

cd "$_WORK_DIR" || exit 1

printf "Updating backup file list ...\n"
tmp_errors=$(mktemp)
tmp_filelist=$(mktemp)

# Generate file list and check for errors
if ! find . -type f | sed 's|^\./||' > "$tmp_filelist"; then
	printf "Error: Failed to generate file list from backup directory\n"
	rm "$tmp_errors" "$tmp_filelist"
	exit 1
fi

# Use rsync with the generated file list
rsync -av --files-from="$tmp_filelist" / "$_WORK_DIR" 2>"$tmp_errors"
if [ $? -ne 0 ]; then
	printf "There were errors updating backup files:\n"
	cat "$tmp_errors" | grep -E "rsync:"
	rm "$tmp_errors" "$tmp_filelist"
	exit 1
fi

rm "$tmp_errors" "$tmp_filelist"


printf "Updating metadata..."

# remove metadata for files no longer present in backup
cleanup_metadata "$_WORK_DIR" "$metadata_file"

files_list=$(find "$_WORK_DIR" -type f)

for backed_up_file in $files_list; do
	printf "."
    # Convert backup path to original system path
    original_file="${backed_up_file#$_WORK_DIR}"
    if [ -f "$original_file" ]; then
		# add or update metadata
        store_metadata "$original_file" "$metadata_file"
    fi
done


cd "$pwd_before_update" || exit 1

printf "Done\n"
