#!/usr/bin/env bash
echo _gg_lib:

os=$(uname -s)

# Default web root if GG_WEB_ROOT is not set
: ${GG_WEB_ROOT:="https://localhost"}

list_layers() {
	for dir in "$GG_BACKUP_ROOT"/*/; do
		[ -d "$dir" ] || continue
		basename "$dir"
	done
}

# prints colored text
print_style () {
    local text=$1

    local colorval=$3

    case $colorval in
		purple)
			COLOR="35m"
			;;
        orange)
            # 256-color orange (works on terminals that support 256 colors)
            COLOR="38;5;208m"
            ;;
		green)
			COLOR="32m"
			;;
		yellow)
			COLOR="33m"
			;;
		red)
			COLOR="31m"
			;;
		iwhite)
			COLOR="97m"
			;;
		*)
			COLOR="0m"
			;;
    esac


    STARTCOLOR="\e[$COLOR";
    ENDCOLOR="\e[0m";

    printf "$STARTCOLOR%$2b$ENDCOLOR" "$text";
}

# Store file metadata (permissions and ownership)
store_metadata() {
    local file="$1"
    local metadata_file="$2"

    # Get the new metadata line
    local new_metadata
    if [ "$os" == "Linux" ]; then
        new_metadata=$(stat -c "%n %a %u %g" "$file")
    else
        # FreeBSD/macOS
        new_metadata=$(stat -f "%N %Mp%Lp %u %g" "$file")
    fi

    # Create metadata file if it doesn't exist
    [ ! -f "$metadata_file" ] && touch "$metadata_file"

    # Escape special characters in filename for sed pattern
    local escaped_file=$(printf '%s\n' "$file" | sed 's/[[\.*^$(){}?+|/]/\\&/g')

    # Check if entry exists and replace or append
    if grep -q "^$escaped_file " "$metadata_file" 2>/dev/null; then
        # Replace existing entry - handle OS differences in sed
        if [ "$os" == "Linux" ]; then
            sed -i "s|^$escaped_file .*|$new_metadata|" "$metadata_file"
        else
            # FreeBSD/macOS requires backup extension
            sed -i '' "s|^$escaped_file .*|$new_metadata|" "$metadata_file"
        fi
    else
        # Add new entry
        echo "$new_metadata" >> "$metadata_file"
    fi
}


# Remove metadata for files that no longer exist in backup
cleanup_metadata() {
    local backup_dir="$1"
    local metadata_file="$2"

    [ ! -f "$metadata_file" ] && return 0
    [ ! -d "$backup_dir" ] && return 0

    # Create a temporary file for cleaned metadata
    local temp_file="${metadata_file}.cleanup_tmp"
    > "$temp_file"

    # Read each line from metadata file
    while read -r file_path perms uid gid; do
        [ -z "$file_path" ] && continue

        # Check if the file exists in the backup directory
        if [ -f "$backup_dir/$file_path" ]; then
            # Keep this metadata entry
            echo "$file_path $perms $uid $gid" >> "$temp_file"
        fi
    done < "$metadata_file"

    # Replace original metadata file with cleaned version
    mv "$temp_file" "$metadata_file"
}

# Restore files metadata from metadata file
restore_metadata() {
    local metadata_file="$1"

    [ ! -f "$metadata_file" ] && return 0

    while read -r file perms uid gid; do
        [ -z "$file" ] && continue
        if [ -e "$file" ]; then
            chmod "$perms" "$file" 2>/dev/null || echo "Warning: Could not set permissions on $file"
            chown "$uid:$gid" "$file" 2>/dev/null || echo "Warning: Could not set ownership on $file (may need sudo)"
        fi
    done < "$metadata_file"
}

# Generate HTML overview of backed up files
generate_html_overview() {
    local work_dir="$1"
    local layer_dir="$2"
    local layer_name="$3"
    local html_file="$layer_dir/content.html"

    [ ! -d "$work_dir" ] && return 1

    # Get total file count and size
    local total_files=0
    local total_size=0
    local generation_date=$(date)

    # Start HTML document
    cat > "$html_file" << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup Overview</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
        .header h1 { margin: 0; font-size: 24px; }
        .stats { display: flex; gap: 20px; margin-top: 10px; font-size: 14px; opacity: 0.9; }
        .search { padding: 20px; border-bottom: 1px solid #eee; }
        .search input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .content { padding: 20px; }
        .folder { margin: 10px 0; }
        .folder-header { cursor: pointer; font-weight: bold; padding: 5px; background: #ecf0f1; border-radius: 4px; display: flex; align-items: center; }
        .folder-header:hover { background: #d5dbdb; }
        .folder-icon { margin-right: 8px; }
        .folder-content { margin-left: 20px; display: none; }
        .folder-content.expanded { display: block; }
        .file { padding: 5px 0; display: flex; align-items: center; border-bottom: 1px solid #f8f9fa; }
        .file:hover { background: #f8f9fa; }
        .file-icon { margin-right: 8px; color: #7f8c8d; }
        .file-name { flex: 1; }
        .file-name a { text-decoration: none; color: #2980b9; }
        .file-name a:hover { text-decoration: underline; }
        .file-meta { font-size: 12px; color: #7f8c8d; text-align: right; min-width: 200px; }
        .hidden { display: none; }

        @media (prefers-color-scheme: dark) {
            body { background: #1a1a1a; }
            .container { background: #2d2d2d; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
            .header { background: #34495e; }
            .search { border-bottom: 1px solid #444; }
            .search input { background: #3a3a3a; border: 1px solid #555; color: white; }
            .search input::placeholder { color: #bbb; }
            .folder-header { background: #3a3a3a; color: #e0e0e0; }
            .folder-header:hover { background: #4a4a4a; }
            .file { border-bottom: 1px solid #3a3a3a; color: #e0e0e0; }
            .file:hover { background: #3a3a3a; }
            .file-icon { color: #bbb; }
            .file-name a { color: #5dade2; }
            .file-meta { color: #bbb; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÇÔ∏è Backup Overview</h1>
EOF

    echo "            <div class=\"stats\">" >> "$html_file"
    echo "                <span>üìÅ Layer: <strong>$layer_name</strong></span>" >> "$html_file"
    echo "                <span>üïê Generated: $generation_date</span>" >> "$html_file"

    # Calculate stats
    if [ -d "$work_dir" ]; then
        cd "$work_dir" || return 1
        total_files=$(find . -type f | wc -l)
        if [ "$os" == "Linux" ]; then
            total_size=$(find . -type f -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')
        else
            total_size=$(find . -type f -exec stat -f%z {} \; | awk '{sum+=$1} END {print sum}')
        fi

        # Convert bytes to human readable
        if [ "$total_size" -gt 1073741824 ]; then
            size_display="$(( total_size / 1073741824 )) GB"
        elif [ "$total_size" -gt 1048576 ]; then
            size_display="$(( total_size / 1048576 )) MB"
        elif [ "$total_size" -gt 1024 ]; then
            size_display="$(( total_size / 1024 )) KB"
        else
            size_display="$total_size bytes"
        fi

        echo "                <span>üìÑ Files: <strong>$total_files</strong></span>" >> "$html_file"
        echo "                <span>üíæ Size: <strong>$size_display</strong></span>" >> "$html_file"
    fi

    cat >> "$html_file" << 'EOF'
            </div>
        </div>
        <div class="search">
            <input type="text" id="searchBox" placeholder="üîç Search files..." onkeyup="filterFiles()">
        </div>
        <div class="content">
EOF

    # Generate file tree
    if [ -d "$work_dir" ]; then
        cd "$work_dir" || return 1

        # Create directory structure
        find . -type d | sort | while read -r dir; do
            [ "$dir" = "." ] && continue

            dir_name=$(basename "$dir")
            dir_path=${dir#./}
            dir_level=$(echo "$dir_path" | tr -cd '/' | wc -c)

            echo "            <div class=\"folder\" style=\"margin-left: ${dir_level}0px;\">" >> "$html_file"
            echo "                <div class=\"folder-header\" onclick=\"toggleFolder(this)\">" >> "$html_file"
            echo "                    <span class=\"folder-icon\">üìÅ</span>" >> "$html_file"
            echo "                    <span>$dir_name/</span>" >> "$html_file"
            echo "                </div>" >> "$html_file"
            echo "                <div class=\"folder-content\">" >> "$html_file"

            # Add files in this directory
            find "$dir" -maxdepth 1 -type f | sort | while read -r file; do
                [ ! -f "$file" ] && continue

                file_name=$(basename "$file")
                file_path=${file#./}
                web_url="$GG_WEB_ROOT/$(basename $GG_BACKUP_ROOT)/$layer_name/_root/$file_path"

                # Get file metadata
                if [ "$os" == "Linux" ]; then
                    file_size=$(stat -c%s "$file" 2>/dev/null || echo "0")
                    file_perms=$(stat -c%a "$file" 2>/dev/null || echo "---")
                    file_mtime=$(stat -c%y "$file" 2>/dev/null | cut -d' ' -f1)
                else
                    file_size=$(stat -f%z "$file" 2>/dev/null || echo "0")
                    file_perms=$(stat -f%Mp%Lp "$file" 2>/dev/null || echo "---")
                    file_mtime=$(stat -f%Sm -t%Y-%m-%d "$file" 2>/dev/null)
                fi

                # Convert file size to human readable
                if [ "$file_size" -gt 1048576 ]; then
                    size_display="$(( file_size / 1048576 )) MB"
                elif [ "$file_size" -gt 1024 ]; then
                    size_display="$(( file_size / 1024 )) KB"
                else
                    size_display="$file_size B"
                fi

                echo "                    <div class=\"file\">" >> "$html_file"
                echo "                        <span class=\"file-icon\">üìÑ</span>" >> "$html_file"
                echo "                        <span class=\"file-name\"><a href=\"$web_url\" target=\"_blank\">$file_name</a></span>" >> "$html_file"
                echo "                        <span class=\"file-meta\">$size_display | $file_perms | $file_mtime</span>" >> "$html_file"
                echo "                    </div>" >> "$html_file"
            done

            echo "                </div>" >> "$html_file"
            echo "            </div>" >> "$html_file"
        done

        # Add files in root directory
        find . -maxdepth 1 -type f | sort | while read -r file; do
            [ ! -f "$file" ] && continue

            file_name=$(basename "$file")
            file_path=${file#./}
            web_url="$GG_WEB_ROOT/$layer_name/_root/$file_path"

            # Get file metadata
            if [ "$os" == "Linux" ]; then
                file_size=$(stat -c%s "$file" 2>/dev/null || echo "0")
                file_perms=$(stat -c%a "$file" 2>/dev/null || echo "---")
                file_mtime=$(stat -c%y "$file" 2>/dev/null | cut -d' ' -f1)
            else
                file_size=$(stat -f%z "$file" 2>/dev/null || echo "0")
                file_perms=$(stat -f%Mp%Lp "$file" 2>/dev/null || echo "---")
                file_mtime=$(stat -f%Sm -t%Y-%m-%d "$file" 2>/dev/null)
            fi

            # Convert file size to human readable
            if [ "$file_size" -gt 1048576 ]; then
                size_display="$(( file_size / 1048576 )) MB"
            elif [ "$file_size" -gt 1024 ]; then
                size_display="$(( file_size / 1024 )) KB"
            else
                size_display="$file_size B"
            fi

            echo "            <div class=\"file\">" >> "$html_file"
            echo "                <span class=\"file-icon\">üìÑ</span>" >> "$html_file"
            echo "                <span class=\"file-name\"><a href=\"$web_url\" target=\"_blank\">$file_name</a></span>" >> "$html_file"
            echo "                <span class=\"file-meta\">$size_display | $file_perms | $file_mtime</span>" >> "$html_file"
            echo "            </div>" >> "$html_file"
        done
    fi

    # Close HTML document
    cat >> "$html_file" << 'EOF'
        </div>
    </div>

    <script>
        function toggleFolder(element) {
            const content = element.nextElementSibling;
            const icon = element.querySelector('.folder-icon');
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.textContent = 'üìÅ';
            } else {
                content.classList.add('expanded');
                icon.textContent = 'üìÇ';
            }
        }

        function filterFiles() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const files = document.querySelectorAll('.file');
            const folders = document.querySelectorAll('.folder');

            files.forEach(file => {
                const fileName = file.querySelector('.file-name').textContent.toLowerCase();
                if (fileName.includes(searchTerm)) {
                    file.classList.remove('hidden');
                } else {
                    file.classList.add('hidden');
                }
            });

            // Show/hide folders based on visible files
            folders.forEach(folder => {
                const visibleFiles = folder.querySelectorAll('.file:not(.hidden)');
                if (visibleFiles.length > 0 || searchTerm === '') {
                    folder.classList.remove('hidden');
                } else {
                    folder.classList.add('hidden');
                }
            });
        }
    </script>
</body>
</html>
EOF

    echo "HTML overview generated: $html_file"
}


