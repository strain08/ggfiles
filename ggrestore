#!/usr/bin/env bash

. $(which _gg_check_root)
. $(which _gg_check_layer) # provides $_WORK_DIR

help="
Usage: ggrestore [--doit] [file_pattern]\n
Restores files from the backup directory to their original locations.\n
--doit\t\t: Restores files. If not specified, script runs in dry-run mode.\n
file_pattern\t: regular expression, applied to whole path.\n
\t\tIf no regex_pattern is provided, all files are restored.\n
"
# COMMAND LINE >>>

case $1 in

	--help | -h)
		printf $help
		exit 0
	;;

	--doit)
		RSYNC_RUN=""
		if [ -z "$2" ]; then
			echo "Restoring all files from backup..."
			specified_file=""
		else
			echo "Searching backup for: " && print_style "$2\n" "" purple
			specified_file="$2"
		fi
	;;

	*)
		RSYNC_RUN="--dry-run"
		print_style "** DRY RUN MODE ** " "" "green" && echo "Use --doit to do it."
		if [ -z "$1" ]; then
			echo "Restoring all files from backup..."
			specified_file=""
		else
			echo "Searching backup for: " && print_style "$1\n" "" purple
			specified_file="$1"
		fi
	;;
esac

# COMMAND LINE <<<

pwd_before_update=$(pwd)
cd "$_WORK_DIR"


tmpfile=$(mktemp)
# Write all found files to the temporary file, stripping leading ./
if [ -z "$specified_file" ]; then
    # If no pattern specified, get all files
    find . -type f | sed 's|^./||' > "$tmpfile"
else
    # Use grep -E instead of egrep for better compatibility
    find . -type f | grep -E "$specified_file" | sed 's|^./||' > "$tmpfile"
fi

# Check if any files were found
if [ ! -s "$tmpfile" ]; then
	echo "No files found matching pattern"
	rm "$tmpfile"
	exit 1
else
	echo "The following files will be restored:"
	echo "---"
	cat "$tmpfile"
	echo "---"
fi

# Count and display files to be restored
count=$(wc -l < "$tmpfile")
echo "Found $count files to restore"

# Use rsync with --files-from
rsync -avq $RSYNC_RUN --files-from="$tmpfile" . /
result=$?

# cleanup
rm "$tmpfile"
cd "$pwd_before_update"

if [ $result -ne 0 ]; then
	echo Errors encountred during restore.
	exit 1
fi

if [ -z "$RSYNC_RUN" ]; then
    echo "Restore completed successfully."

	# Restore metadata (permissions and ownership)
	metadata_file="$_LAYER_DIR/.permissions"
	if [ -f "$metadata_file" ]; then
		printf "Restoring file permissions and ownership..."
		restore_metadata "$metadata_file"
		echo "done."
	else
		echo "No metadata file found. File permissions preserved from rsync."
	fi
else
    print_style "Dry run completed." "" green && echo " Use --doit to perform the actual restore"
fi
