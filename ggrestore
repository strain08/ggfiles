#!/usr/bin/env bash

. $(which _gg_check_root)
. $(which _gg_check_layer) # provides $_ROOT_DIR and $_HOME_DIR

help="
Usage: ggrestore [--doit] [file_pattern]
Restores files from the backup directory to their original locations.
--doit\t\t: Restores files. If not specified, script runs in dry-run mode.
file_pattern\t: regular expression, applied to whole path.
\t\tIf no regex_pattern is provided, all files are restored.
"
# COMMAND LINE >>>

case $1 in

	--help | -h)
		printf "$help"
		exit 0
	;;

	--doit)
		RSYNC_RUN=""
		if [ -z "$2" ]; then
			echo "Restoring all files from backup..."
			specified_file=""
		else
			echo -e "Searching backup for: ${FG_MAGENTA}$2 ${RESET}"
			specified_file="$2"
		fi
	;;

	*)
		RSYNC_RUN="--dry-run"
		echo -e "${FG_GREEN}** DRY RUN MODE ** ${RESET}Use --doit to do it."
		if [ -z "$1" ]; then
			echo "Restoring all files from backup..."
			specified_file=""
		else
			echo -e "Searching backup for: ${FG_MAGENTA}$1 ${RESET}"
			specified_file="$1"
		fi
	;;
esac

# COMMAND LINE <<<

pwd_before_restore=$(pwd)

# Create temporary files for ROOT and HOME file lists
tmpfile_root=$(mktemp)
tmpfile_home=$(mktemp)

# Collect files from _root/
echo "Scanning _root/ backups..."
cd "$_ROOT_DIR" || exit 1
if [ -z "$specified_file" ]; then
    # If no pattern specified, get all files
    find . -type f 2>/dev/null | sed 's|^./||' > "$tmpfile_root"
else
    # Use grep -E for pattern matching
    find . -type f 2>/dev/null | grep -E "$specified_file" | sed 's|^./||' > "$tmpfile_root"
fi

# Collect files from _home/
echo "Scanning _home/ backups..."
if [ -d "$_HOME_DIR" ]; then
    cd "$_HOME_DIR" || exit 1
    if [ -z "$specified_file" ]; then
        find . -type f 2>/dev/null | sed 's|^./||' > "$tmpfile_home"
    else
        find . -type f 2>/dev/null | grep -E "$specified_file" | sed 's|^./||' > "$tmpfile_home"
    fi
else
    > "$tmpfile_home"
fi

# Check if any files were found
if [ ! -s "$tmpfile_root" ] && [ ! -s "$tmpfile_home" ]; then
	echo "No files found matching pattern"
	rm "$tmpfile_root" "$tmpfile_home"
	exit 1
fi

# Display files to be restored
echo "The following files will be restored:"
echo "---"
if [ -s "$tmpfile_root" ]; then
    echo "FROM ROOT (_root/):"
    cat "$tmpfile_root" | sed 's/^/  /'
fi
if [ -s "$tmpfile_home" ]; then
    echo "FROM HOME (_home/):"
    cat "$tmpfile_home" | sed 's/^/  /'
fi
echo "---"

# Count and display files to be restored
count_root=$(wc -l < "$tmpfile_root" 2>/dev/null || echo 0)
count_home=$(wc -l < "$tmpfile_home" 2>/dev/null || echo 0)
total_count=$((count_root + count_home))
echo "Found $total_count files to restore (ROOT: $count_root, HOME: $count_home)"

# Restore ROOT files (absolute paths to /)
result_root=0
if [ -s "$tmpfile_root" ]; then
    echo "Restoring ROOT files..."
    cd "$_ROOT_DIR" || exit 1
    rsync -avq $RSYNC_RUN --files-from="$tmpfile_root" . /
    result_root=$?
fi

# Restore HOME files (relative paths to HOME)
result_home=0
if [ -s "$tmpfile_home" ]; then
    echo "Restoring HOME files..."
    if [ -d "$_HOME_DIR" ]; then
        cd "$_HOME_DIR" || exit 1
        rsync -avq $RSYNC_RUN --files-from="$tmpfile_home" . "$HOME/"
        result_home=$?
    fi
fi

# Check for errors
if [ $result_root -ne 0 ] || [ $result_home -ne 0 ]; then
	rm "$tmpfile_root" "$tmpfile_home"
	echo "Errors encountered during restore."
	exit 1
fi

cd "$pwd_before_restore" || exit 1

if [ -z "$RSYNC_RUN" ]; then
    echo "Restore completed successfully."

	# Restore metadata (permissions and ownership) selectively - only for files that were restored
	metadata_root="$_LAYER_DIR/.permissions_root"
	metadata_home="$_LAYER_DIR/.permissions_home"
	metadata_found=0

	if [ -f "$metadata_root" ] && [ -s "$tmpfile_root" ]; then
		printf "Restoring ROOT file permissions and ownership..."
		restore_metadata_selective "$metadata_root" "ROOT" "$tmpfile_root" || {
			echo ""
			echo "Error: Cannot restore file permissions. Check directory write access." >&2
			echo "Please try again with elevated permissions: sudo ggrestore [options]" >&2
			rm "$tmpfile_root" "$tmpfile_home"
			exit 1
		}
		echo "done."
		metadata_found=1
	fi

	if [ -f "$metadata_home" ] && [ -s "$tmpfile_home" ]; then
		printf "Restoring HOME file permissions and ownership..."
		restore_metadata_selective "$metadata_home" "HOME" "$tmpfile_home" || {
			echo ""
			echo "Error: Cannot restore file permissions to user home directory." >&2
			echo "Please try again with elevated permissions: sudo ggrestore [options]" >&2
			rm "$tmpfile_root" "$tmpfile_home"
			exit 1
		}
		echo "done."
		metadata_found=1
	fi

	if [ $metadata_found -eq 0 ]; then
		echo "No metadata files found. File permissions preserved from rsync."
	fi
else
    echo -e "${FG_GREEN}Dry run completed.${RESET} Use --doit to perform the actual restore"
fi

# cleanup - remove temp files after metadata restoration
rm "$tmpfile_root" "$tmpfile_home" 2>/dev/null
