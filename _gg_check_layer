#!/usr/bin/env bash
#echo _gg_check_layer:

. $(which _gg_lib)

[ -f /tmp/gg_layer.env ] && . /tmp/gg_layer.env

if [ -z "$GG_LAYER" ]; then
	echo "_gg_check_layer: GG_LAYER is not set."
	echo "_gg_check_layer: Run gglayer <layer_name> to create/select layer."
	echo _gg_check_layer: Available layers:
	list_layers
	exit 1
fi

# define working directories
_backup_root=$GG_BACKUP_ROOT

# add ending slash if absent
[[ "$_backup_root" != */ ]] && _backup_root="$_backup_root"/

_LAYER_DIR="$_backup_root$GG_LAYER"
_ROOT_DIR="$_LAYER_DIR/_root"
_HOME_DIR="$_LAYER_DIR/_home"
metadata_file_root="$_LAYER_DIR/.permissions_root"
metadata_file_home="$_LAYER_DIR/.permissions_home"

if [ ! -d $_LAYER_DIR ]; then
	echo "$_LAYER_DIR not found. Abort."
	exit 1
else
	printf "Selected layer: " && print_style "$GG_LAYER\n" "" orange
fi

if [ -d "$_ROOT_DIR" ]; then
	printf "ROOT directory: " && print_style "$_ROOT_DIR\n" "" orange
else
	echo "_ROOT dir not found. Creating empty $_ROOT_DIR..."
	mkdir -p "$_ROOT_DIR" 2>/dev/null || {
		echo "Warning: Could not create _root directory at $_ROOT_DIR"
	}
fi

# Ensure _home/ directory exists (create if missing)
if [ -d "$_HOME_DIR" ]; then
	printf "HOME directory: " && print_style "$_HOME_DIR\n" "" orange
else
	echo "_HOME dir not found. Creating empty $_HOME_DIR..."
	mkdir -p "$_HOME_DIR" 2>/dev/null || {
		echo "Warning: Could not create _home directory at $_HOME_DIR"
	}
fi

# Export for use in other commands
export _ROOT_DIR
export _HOME_DIR
export metadata_file_root
export metadata_file_home
