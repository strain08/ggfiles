#!/usr/bin/env bash
#echo _gg_check_layer:

. $(which _gg_lib)

[ -f /tmp/gg_layer.env ] && . /tmp/gg_layer.env

if [ -z "$GG_LAYER" ]; then
	echo "_gg_check_layer: GG_LAYER is not set."
	echo "_gg_check_layer: Run gglayer <layer_name> to create/select layer."
	echo _gg_check_layer: Available layers:
	list_layers
	exit 1
fi

# define working directories
_WORK_DIR=$GG_BACKUP_ROOT

# add ending slash if absent
[[ "$_WORK_DIR" != */ ]] && _WORK_DIR="$_WORK_DIR"/

_LAYER_DIR="$_WORK_DIR$GG_LAYER"
_WORK_DIR="$_LAYER_DIR/_root"
_HOME_DIR="$_LAYER_DIR/_home"
metadata_file_root="$_LAYER_DIR/.permissions_root"
metadata_file_home="$_LAYER_DIR/.permissions_home"

if [ -d "$_WORK_DIR" ]; then
	printf "Selected layer: " && print_style "$GG_LAYER\n" "" orange
	printf "Working directory: " && print_style "$_LAYER_DIR\n" "" orange
else
	echo "Working dir not found." && exit 1
fi

# Ensure _home/ directory exists (create if missing)
if [ ! -d "$_HOME_DIR" ]; then
	mkdir -p "$_HOME_DIR" 2>/dev/null || {
		echo "Warning: Could not create _home directory at $_HOME_DIR"
	}
fi

# Export for use in other commands
export _HOME_DIR
export metadata_file_root
export metadata_file_home
