#!/usr/bin/env bash

# sets the working layer as GG_LAYER env var
# all commands should work on this layer or fail

. $(which _gg_check_root)
. $(which _gg_lib)

help="
Usage: ggselect <layer-name>
"

if [ -z "$1" ]; then
	echo $help
	echo Available layers:
	list_layers
	if [ -f /tmp/gg_layer.env ]; then
		. /tmp/gg_layer.env
		echo Active layer: $GG_LAYER
	fi
	exit
fi

# no spaces allowed in layer name
GG_LAYER=$( echo "$1" | tr -d '[:space:]' )
LAYER_HOME="$GG_BACKUP_ROOT/$GG_LAYER/_home"
LAYER_ROOT="$GG_BACKUP_ROOT/$GG_LAYER/_root"

if [ -d "$LAYER_ROOT" ] || [ -d "$LAYER_HOME" ]; then
    echo "Layer '$GG_LAYER' exists at $GG_BACKUP_ROOT/$GG_LAYER"
    echo ""
    echo ROOT files:
    [ -d "$LAYER_ROOT" ] && find "$LAYER_ROOT" -type f
	echo ""
    echo HOME files:
    [ -d "$LAYER_HOME" ] && find "$LAYER_HOME" -type f
	echo ""
else
    echo "Creating new repository layer at $GG_BACKUP_ROOT/$GG_LAYER"
fi

# Ensure both _root/ and _home/ directories exist
mkdir -p "$LAYER_ROOT" "$LAYER_HOME" 2>/dev/null

if [ $? -ne 0 ]; then
    echo "Error: Unable to create directories at $GG_BACKUP_ROOT/$GG_LAYER"
    echo "Layer not set."
    exit 1
fi

echo "GG_LAYER=$GG_LAYER" > /tmp/gg_layer.env || {
    echo "Error: Cannot create layer env file" >&2
    exit 1
}
chmod 666 /tmp/gg_layer.env || {
    echo "Error: Cannot set permissions on layer env file. Try: sudo gglayer $1" >&2
    exit 1
}

if [ -d "$LAYER_ROOT" ] || [ -d "$LAYER_HOME" ]; then
    echo "Layer '$GG_LAYER' is now active."
else
    echo "Layer '$GG_LAYER' created at $GG_BACKUP_ROOT/$GG_LAYER'"
    echo "Layer '$GG_LAYER' is now active."
fi
exit 0

